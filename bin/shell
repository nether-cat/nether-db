#!/usr/bin/env node

const XLSX = require('xlsx');
const util = require('util');
const db = require('../models');

let models = Object.values(db.sequelize.models)
  .filter(model => model.name.indexOf('_record') !== -1);

let args = process.argv.slice(2);
let workbook = XLSX.readFile(args[0]);
let sheet, sheetTitle;
let sheetNotFound = function () {
  throw new Error('Sheet with records not found!');
};
try {
  sheet = workbook.Sheets['Varves'];
  sheetTitle = sheet['B2'].v.trim().toLowerCase();
} catch (e) {
  sheetNotFound();
} finally {
  if ('varves template' !== sheetTitle) sheetNotFound();
}
let regex = /^[A-Z]{1,3}\d+:([A-Z]{1,3})(\d+)$/g;
let [, lastColumn, lastRow] = regex.exec(sheet['!ref']);
let keysRange = util.format('A8:%s%s', lastColumn, '8');
let valuesRange = util.format('A9:%s%s', lastColumn, lastRow);
let keys = XLSX.utils.sheet_to_json(sheet, {header: 1, range: keysRange})[0];
let json = XLSX.utils.sheet_to_json(sheet, {header: keys, range: valuesRange});

console.log('Done!');
